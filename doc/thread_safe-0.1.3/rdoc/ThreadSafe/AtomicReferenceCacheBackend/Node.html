<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Class: ThreadSafe::AtomicReferenceCacheBackend::Node</title>

  <link rel="stylesheet" href="../../rdoc.css" type="text/css" media="screen" />

  <script src="../../js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="../../js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="../../js/quicksearch.js" type="text/javascript" charset="utf-8"></script>
  <script src="../../js/darkfish.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../../index.html">Home</a>
          <a href="../../index.html#classes">Classes</a>
          <a href="../../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="../../lib/thread_safe/atomic_reference_cache_backend_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="lib/thread_safe/atomic_reference_cache_backend.rb">lib/thread_safe/atomic_reference_cache_backend.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      
      <!-- Parent Class -->
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link">Object</p>
        
      </div>
      

      

      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-new">::new</a></li>
          
          <li><a href="#method-i-key-3F">#key?</a></li>
          
          <li><a href="#method-i-locked-3F">#locked?</a></li>
          
          <li><a href="#method-i-matches-3F">#matches?</a></li>
          
          <li><a href="#method-i-pure_hash">#pure_hash</a></li>
          
          <li><a href="#method-i-try_await_lock">#try_await_lock</a></li>
          
          <li><a href="#method-i-try_lock_via_hash">#try_lock_via_hash</a></li>
          
          <li><a href="#method-i-unlock_via_hash">#unlock_via_hash</a></li>
          
        </ul>
      </div>
      

      
      <!-- Included Modules -->
      <div id="includes-section" class="section">
        <h3 class="section-header">Included Modules</h3>
        <ul class="link-list">
        
        
          <li><a class="include" href="../Util/CheapLockable.html">ThreadSafe::Util::CheapLockable</a></li>
        
        
        </ul>
      </div>
      
    </div>

    <div id="project-metadata">
      
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="../../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../../ThreadSafe.html">ThreadSafe</a></li>
        
          <li><a href="../../ThreadSafe/Array.html">ThreadSafe::Array</a></li>
        
          <li><a href="../../ThreadSafe/AtomicReferenceCacheBackend.html">ThreadSafe::AtomicReferenceCacheBackend</a></li>
        
          <li><a href="../../ThreadSafe/AtomicReferenceCacheBackend/Node.html">ThreadSafe::AtomicReferenceCacheBackend::Node</a></li>
        
          <li><a href="../../ThreadSafe/AtomicReferenceCacheBackend/Table.html">ThreadSafe::AtomicReferenceCacheBackend::Table</a></li>
        
          <li><a href="../../ThreadSafe/Cache.html">ThreadSafe::Cache</a></li>
        
          <li><a href="../../ThreadSafe/Hash.html">ThreadSafe::Hash</a></li>
        
          <li><a href="../../ThreadSafe/MriCacheBackend.html">ThreadSafe::MriCacheBackend</a></li>
        
          <li><a href="../../ThreadSafe/NonConcurrentCacheBackend.html">ThreadSafe::NonConcurrentCacheBackend</a></li>
        
          <li><a href="../../ThreadSafe/SynchronizedCacheBackend.html">ThreadSafe::SynchronizedCacheBackend</a></li>
        
          <li><a href="../../ThreadSafe/Util.html">ThreadSafe::Util</a></li>
        
          <li><a href="../../ThreadSafe/Util/Adder.html">ThreadSafe::Util::Adder</a></li>
        
          <li><a href="../../ThreadSafe/Util/CheapLockable.html">ThreadSafe::Util::CheapLockable</a></li>
        
          <li><a href="../../ThreadSafe/Util/PowerOfTwoTuple.html">ThreadSafe::Util::PowerOfTwoTuple</a></li>
        
          <li><a href="../../ThreadSafe/Util/Striped64.html">ThreadSafe::Util::Striped64</a></li>
        
          <li><a href="../../ThreadSafe/Util/Striped64/Cell.html">ThreadSafe::Util::Striped64::Cell</a></li>
        
          <li><a href="../../ThreadSafe/Util/Volatile.html">ThreadSafe::Util::Volatile</a></li>
        
          <li><a href="../../ThreadSafe/Util/VolatileTuple.html">ThreadSafe::Util::VolatileTuple</a></li>
        
          <li><a href="../../ThreadSafe/Util/XorShiftRandom.html">ThreadSafe::Util::XorShiftRandom</a></li>
        
          <li><a href="../../SynchronizedDelegator.html">SynchronizedDelegator</a></li>
        
          <li><a href="../../Threadsafe.html">Threadsafe</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">ThreadSafe::AtomicReferenceCacheBackend::Node</h1>

    <div id="description" class="description">
      
<p>Key-value entry. Nodes with a hash field of <tt>MOVED</tt> are special, and
do not contain user keys or values.  Otherwise, keys are never
<tt>nil</tt>, and <tt>NULL</tt> <tt>value</tt> fields indicate that a node
is in the process of being deleted or created. For purposes of read-only
access, a key may be read before a value, but can only be used after
checking value to be +!= NULL+.</p>

    </div><!-- description -->

    
    
    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      
      <!-- Constants -->
      <div id="constants-list" class="section">
        <h3 class="section-header">Constants</h3>
        <dl>
        
          <dt><a name="HASH_BITS">HASH_BITS</a></dt>
          
          <dd class="description"></dd>
          
        
          <dt><a name="LOCKED">LOCKED</a></dt>
          
          <dd class="description"></dd>
          
        
          <dt><a name="MOVED">MOVED</a></dt>
          
          <dd class="description"><p>Encodings for special uses of <a href="Node.html">Node</a> hash fields. See
above for explanation.</p></dd>
          
        
          <dt><a name="SPIN_LOCK_ATTEMPTS">SPIN_LOCK_ATTEMPTS</a></dt>
          
          <dd class="description"></dd>
          
        
          <dt><a name="WAITING">WAITING</a></dt>
          
          <dd class="description"></dd>
          
        
        </dl>
      </div>
      

      
      <!-- Attributes -->
      <div id="attribute-method-details" class="method-section section">
        <h3 class="section-header">Attributes</h3>

        
        <div id="key-attribute-method" class="method-detail">
          <a name="key"></a>
          
          <div class="method-heading attribute-method-heading">
            <span class="method-name">key</span><span
              class="attribute-access-type">[R]</span>
          </div>

          <div class="method-description">
          
          
          
          </div>
        </div>
        
      </div><!-- attribute-method-details -->
      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="new-method" class="method-detail ">
          <a name="method-c-new"></a>

          
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">(hash, key, value, next_node = nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="new-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 254</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">hash</span>, <span class="ruby-identifier">key</span>, <span class="ruby-identifier">value</span>, <span class="ruby-identifier">next_node</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">super</span>()
  <span class="ruby-ivar">@key</span> = <span class="ruby-identifier">key</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lazy_set_hash</span>(<span class="ruby-identifier">hash</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lazy_set_value</span>(<span class="ruby-identifier">value</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">next</span> = <span class="ruby-identifier">next_node</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- new-source -->
            
          </div>

          

          
        </div><!-- new-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="key-3F-method" class="method-detail ">
          <a name="method-i-key-3F"></a>

          
          <div class="method-heading">
            <span class="method-name">key?</span><span
              class="method-args">(key)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="key-3F-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 294</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">key?</span>(<span class="ruby-identifier">key</span>)
  <span class="ruby-ivar">@key</span>.<span class="ruby-identifier">eql?</span>(<span class="ruby-identifier">key</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- key-3F-source -->
            
          </div>

          

          
        </div><!-- key-3F-method -->

      
        <div id="locked-3F-method" class="method-detail ">
          <a name="method-i-locked-3F"></a>

          
          <div class="method-heading">
            <span class="method-name">locked?</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="locked-3F-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 316</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">locked?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">locked_hash?</span>(<span class="ruby-identifier">hash</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- locked-3F-source -->
            
          </div>

          

          
        </div><!-- locked-3F-method -->

      
        <div id="matches-3F-method" class="method-detail ">
          <a name="method-i-matches-3F"></a>

          
          <div class="method-heading">
            <span class="method-name">matches?</span><span
              class="method-args">(key, hash)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="matches-3F-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 298</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">matches?</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">hash</span>)
  <span class="ruby-identifier">pure_hash</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">hash</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">key?</span>(<span class="ruby-identifier">key</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- matches-3F-source -->
            
          </div>

          

          
        </div><!-- matches-3F-method -->

      
        <div id="pure_hash-method" class="method-detail ">
          <a name="method-i-pure_hash"></a>

          
          <div class="method-heading">
            <span class="method-name">pure_hash</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="pure_hash-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 302</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">pure_hash</span>
  <span class="ruby-identifier">hash</span> &amp; <span class="ruby-constant">HASH_BITS</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- pure_hash-source -->
            
          </div>

          

          
        </div><!-- pure_hash-method -->

      
        <div id="try_await_lock-method" class="method-detail ">
          <a name="method-i-try_await_lock"></a>

          
          <div class="method-heading">
            <span class="method-name">try_await_lock</span><span
              class="method-args">(table, i)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Spins a while if <tt>LOCKED</tt> bit set and this node is the first of its
bin, and then sets <tt>WAITING</tt> bits on hash field and blocks (once) if
they are still set.  It is OK for this method to return even if lock is not
available upon exit, which enables these simple single-wait mechanics.</p>

<p>The corresponding signalling operation is performed within callers: Upon
detecting that <tt>WAITING</tt> has been set when unlocking lock (via a
failed CAS from non-waiting <tt>LOCKED</tt> state), unlockers acquire the
<tt>cheap_synchronize</tt> lock and perform a <tt>cheap_broadcast</tt>.</p>
            

            
            <div class="method-source-code" id="try_await_lock-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 273</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_await_lock</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">i</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">table</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">table</span>.<span class="ruby-identifier">size</span> <span class="ruby-comment"># bounds check, TODO: why are we bounds checking?</span>
    <span class="ruby-identifier">spins</span> = <span class="ruby-constant">SPIN_LOCK_ATTEMPTS</span>
    <span class="ruby-identifier">randomizer</span> = <span class="ruby-identifier">base_randomizer</span> = <span class="ruby-constant">Util</span><span class="ruby-operator">::</span><span class="ruby-constant">XorShiftRandom</span>.<span class="ruby-identifier">get</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">equal?</span>(<span class="ruby-identifier">table</span>.<span class="ruby-identifier">volatile_get</span>(<span class="ruby-identifier">i</span>)) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">locked_hash?</span>(<span class="ruby-identifier">my_hash</span> = <span class="ruby-identifier">hash</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">spins</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">randomizer</span> = (<span class="ruby-identifier">randomizer</span> <span class="ruby-operator">&gt;&gt;</span> <span class="ruby-value">1</span>)).<span class="ruby-identifier">even?</span> <span class="ruby-comment"># spin at random</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">spins</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
            <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">pass</span> <span class="ruby-comment"># yield before blocking</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">randomizer</span> = <span class="ruby-identifier">base_randomizer</span> = <span class="ruby-constant">Util</span><span class="ruby-operator">::</span><span class="ruby-constant">XorShiftRandom</span>.<span class="ruby-identifier">xorshift</span>(<span class="ruby-identifier">base_randomizer</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">randomizer</span>.<span class="ruby-identifier">zero?</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">cas_hash</span>(<span class="ruby-identifier">my_hash</span>, <span class="ruby-identifier">my_hash</span> <span class="ruby-operator">|</span> <span class="ruby-constant">WAITING</span>)
        <span class="ruby-identifier">force_aquire_lock</span>(<span class="ruby-identifier">table</span>, <span class="ruby-identifier">i</span>)
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- try_await_lock-source -->
            
          </div>

          

          
        </div><!-- try_await_lock-method -->

      
        <div id="try_lock_via_hash-method" class="method-detail ">
          <a name="method-i-try_lock_via_hash"></a>

          
          <div class="method-heading">
            <span class="method-name">try_lock_via_hash</span><span
              class="method-args">(node_hash = hash)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="try_lock_via_hash-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 306</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">try_lock_via_hash</span>(<span class="ruby-identifier">node_hash</span> = <span class="ruby-identifier">hash</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">cas_hash</span>(<span class="ruby-identifier">node_hash</span>, <span class="ruby-identifier">locked_hash</span> = <span class="ruby-identifier">node_hash</span> <span class="ruby-operator">|</span> <span class="ruby-constant">LOCKED</span>)
    <span class="ruby-keyword">begin</span>
      <span class="ruby-keyword">yield</span>
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">unlock_via_hash</span>(<span class="ruby-identifier">locked_hash</span>, <span class="ruby-identifier">node_hash</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- try_lock_via_hash-source -->
            
          </div>

          

          
        </div><!-- try_lock_via_hash-method -->

      
        <div id="unlock_via_hash-method" class="method-detail ">
          <a name="method-i-unlock_via_hash"></a>

          
          <div class="method-heading">
            <span class="method-name">unlock_via_hash</span><span
              class="method-args">(locked_hash, node_hash)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="unlock_via_hash-source">
<pre>
<span class="ruby-comment"># File lib/thread_safe/atomic_reference_cache_backend.rb, line 320</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">unlock_via_hash</span>(<span class="ruby-identifier">locked_hash</span>, <span class="ruby-identifier">node_hash</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">cas_hash</span>(<span class="ruby-identifier">locked_hash</span>, <span class="ruby-identifier">node_hash</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hash</span> = <span class="ruby-identifier">node_hash</span>
    <span class="ruby-identifier">cheap_synchronize</span> { <span class="ruby-identifier">cheap_broadcast</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- unlock_via_hash-source -->
            
          </div>

          

          
        </div><!-- unlock_via_hash-method -->

      
      </div><!-- public-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

